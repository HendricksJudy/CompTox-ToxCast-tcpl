---
title: tcpl v3.0 <br />Data Retrieval<br />
author: "National Center for Computational Toxicology, US EPA"
output:
  prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{tcpl 2.0 <br />Data Retrieval<br />}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---
<!-- This CSS script ensures autonumbering of equations-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });
</script>


<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

```{r echo=FALSE, message=FALSE, warning=FALSE}
## Primary R Packages ##
library(tcpl)
library(tcplfit2)
## Data Formatting ##
library(dplyr)
library(magrittr)
## Plotting ##
library(ggplot2)
library(RColorBrewer)
library(colorspace)
library(viridis)
```

# Data Retrieval

This vignette describes how the user can retrieve data from the ToxCast databases using <font face="CMTT10">tcpl</font>. Listed below are case examples that extract summary information about the chemical, *Bisphenol A*, and the assay, *NVS_NR_hTRa*. The multiple concentration table for level 5 can be downloaded from the publicly available ToxCast data https://www.epa.gov/chemical-research/exploring-toxcast-data-downloadable-data. 

## Load Chemical Information from the Database

Here, we illustrate the necessary steps for extracting information about *Bisphenol A* using <font face="CMTT10">tcpl</font>.

First, we need to connect to the database (DB) and specify the driver with <font face="CMTT10">tcpl</font>.  In the following example the driver settings is MySQL and we specify that we want to connect to the database 'invitrodb':

```{r eval = FALSE}
## Connect to the 'invitrodb' database in MySQL ##
tcplConf(user = 'XXXXXXX', # provide your username for the DB
         pass = 'XXXXXXX', # provide your password for the DB
         host = 'XXXXXXX', # provide the host where the DB is stored
         db = 'invitrodb', # provide the name of the DB
         drvr = 'MySQL')   # provide the DB platform (i.e. driver)
## Print the Connection Information ##
tcplConfList()
```

Next, we define the chemical of interest and load the related sample id's ($\mathit{spids}$):

```{r eval = FALSE}
## Obtain the `spids` for a Given Chemical ##
# Provide the chemical name and assign to 'chnm'.
chnm <- 'Bisphenol A'
# Load the chemical data from the database.
chem <- tcplLoadChem(field = 'chnm',val = chnm)
```

## Load Sample Data for a Chemical from the Database

In the following section, we provide examples of how to load data from different levels and how to summarize results for the chemical of interest, namely *Bisphenol A*. The following code chunk provides the basic data retrieval from the database, then will be followed by more complex examples.

```{r eval=FALSE}
## Basic Data Loading ##
# Provide a level of data to extract from the database.
datlvl <- 5
# Load data from the database.
chemdat <- tcplLoadData(lvl = datlvl, # data level 
                        fld = 'spid', # field corresponding to ID's in `val`
                        val = chem[,spid], # the ID's to pull data for
                        type = 'mc') # the data type - multiple concentration
```

In the example above, we are loading the level 5 multiple concentration data for the sample ID's ($\mathit{spid}$) that were obtained in the chemical information section above.  The user should note that the basic data loading can be adjusted to obtain different applicable data levels one may want to evaluate.  For single-concentration (sc) data, one can load data from levels 0 through 2.  For multiple-concentration (mc) data, one can load data from levels 0 through 5 (future versions of <font face="CMTT10">tcpl</font> may also include level 6 data with curve-fit flags - see the Data processing vignette for more information). 


Then, we load the data from different levels to summarize positive responses for this chemical.

```{r eval = FALSE}
dat5 <- tcplPrepOtpt(tcplLoadData
                     (lvl = 5, fld = 'spid', 
                       val = chem$spid, type = 'mc'))
## For positives only, hit call (hitc) should equal 1
dat5 <- dat5[hitc == 1] 
dat6 <- tcplPrepOtpt(tcplLoadData
                     (lvl = 6, fld = 'spid', val = chem$spid, 
                       type = 'mc'))
mc6_mthds <- dat6[ , .( mc6_mthd_id = 
                          paste(mc6_mthd_id, collapse = ",")), 
                   by = m4id]
mc6_flags <- dat6[ , .( flag = 
                          paste(flag, collapse = ";")), 
                   by = m4id]
```

Then, we can generate all level 6 plots for positive responses for this chemical:

```{r eval = FALSE}
m4ids <- dat5[ , m4id]
graphics.off()
pdf(file = file.path(getwd(),
                   paste("mc6",
                         paste(chnm,collapse = "."),
                         format(Sys.Date(),
                                "%y%m%d.pdf"),
                         sep = "_")),
    height = 6,
    width = 10,
    pointsize = 10)
tcplPlotM4ID(m4ids, lvl = 6)
graphics.off()
```

In the following example, we will obtain summary information about the example assay NVS_NR_hTRa_Antagonist using <font face="CMTT10">tcpl</font>:


```{r eval = FALSE}
## List the assay source IDs
tcplLoadAsid() 
## Find the assay source (NVS)
nvs.assays <- tcplLoadAeid(fld='asid', val = 5) 
## Find the assay name (hTRa)
aeids <- nvs.assays[grep("hTRa", aenm)]$aeid 
## Load the mc5 to determine hit call and summary information
dat5 <- tcplPrepOtpt(tcplLoadData(lvl = 5, type = 'mc', 
                                  fld = 'aeid', val = aeids)) 
dat5 <- dat5[hitc == 1]
## Make the level 6 plots for the positive responses
assay <- 'NVS_NR_hTRa_Antagonist'
m4ids <- dat5[ , m4id]
graphics.off()
pdf(file = file.path(getwd(),
                   paste("mc6",
                         paste(assay,collapse = "."),
                         format(Sys.Date(),
                                "%y%m%d.pdf"),
                         sep = "_")),
    height = 6,
    width = 10,
    pointsize = 10)
tcplPlotM4ID(m4ids, lvl = 6)
graphics.off()
```

Moreover, we can extract the mc3 data used for plots:

```{r eval = FALSE}
spids <- unique(dat5[,spid])
## logc = log10concentration, starting with micromolar
## units (x-axis), resp = normalized response value (y-axis)
mc3 <- tcplPrepOtpt(tcplLoadData
                    (lvl = 3, type = 'mc', fld = 'spid',
                      val = spids))
mc3 <- mc3[aeid %in% aeids]
```

Then, we can visualize the normalized mc3 data without <font face="CMTT10">tcpl</font> curve-fitting:

```{r eval = FALSE}
graphics.off()
pdf(file = file.path(getwd(),
                   paste("mc3",
                         paste(assay,collapse = "."),
                         format(Sys.Date(),
                                "%y%m%d.pdf"),
                         sep = "_")),
    height = 6,
    width = 10,
    pointsize = 10)

by(mc3, mc3$spid, function (x){
  ggplot(x, aes(x = logc, y = resp), tab) +
    geom_point(aes(group=spid, color=spid)) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(size=rel(0.5)),
          axis.ticks.y = element_blank(),
          axis.text.y = element_blank()) +
    xlab("logc") + ylab("resp")
}
)
graphics.off()
```

The <font face="CMTT10"> tcplLoadData</font> function can be used to load data from level 7. The added level allows for estimating the uncertainty in the fitted parameters, such as AC~50~.

---
title: tcpl v3.0 <br />Data Retrieval<br />
author: "Center for Computational Toxicology and Exposure, US EPA"
output:
  prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{tcpl v3.0 <br />Data Retrieval<br />}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---
<!-- This CSS script ensures autonumbering of equations-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });
</script>


<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

# R Packages

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Primary Packages #
library(tcpl)
library(tcplfit2)
# Data Formatting Packages #
library(dplyr)
library(magrittr)
# Plotting Packages #
library(ggplot2)
library(RColorBrewer)
library(colorspace)
library(viridis)
```

# Introduction

This vignette describes how the user can retrieve data from the ToxCast databases using <font face="CMTT10">tcpl</font>. The MySQL version of the ToxCast database containing all the publicly available ToxCast data is available for download at: <https://www.epa.gov/chemical-research/exploring-toxcast-data-downloadable-data>.

## Overview of Key Functions

To support different data retrieval needs within <font face="CMTT10">tcpl</font>, there are a number of functions which query the database and return information.

### Assay Elements

The <font face="CMTT10">tcplLoadAsid</font>, <font face="CMTT10">tcplLoadAid</font>, <font face="CMTT10">tcplLoadAcid</font>, <font face="CMTT10">tcplLoadAeid</font> functions load relevant ids and names for their respective assay elements based on given parameters. 

```{r tcplLoad, eval = FALSE}
# List all assay source IDs
tcplLoadAsid() 
# Create table of all assay endpoint ids (aeids) per assay source
aeids <- tcplLoadAeid(fld="asid", # field to query on
                      val=14, # value for each field, must be same order as 'fld'
                      add.fld = c("aid", "anm", "acid", "acnm")) # additional fields to return
```

### Data

The <font face="CMTT10">tcplQuery</font> function can be used to load the data from the MySQL database into the R session using SQL queries. Any SQL query can replace the one provided in this example.

```{r tcplquery, eval = FALSE}
# Load sample table
samples <- tcplQuery("SELECT * FROM sample;")
```

The <font face="CMTT10">tcplLoadData</font> function can be used to load the data from the MySQL database into the R session. The <font face="CMTT10">tcplPrepOtpt</font> function can be used in combination with <font face="CMTT10">tcplLoadData</font> prepare a readable output for use by querying the chemical and assay identifiers and mapping the annotation information to the given data. 

When loading data, the user must indicate correct field and id for corresponding level. Loading Level 0 (SC0 and MC0), MC1, and MC2 will always use $\mathit{acid}$. As described in Table 1 of the processing vignette, SC1 and MC3 levels are the normalization steps where $\mathit{acid}$ is converted to $\mathit{aeid}$. These tables contain both IDs therefore data can be loaded using either id as long as properly specified. Loading SC2, MC4, and MC5 will use $\mathit{aeid}$. Selected id(s) are based on the primary key within each data-containing table. Examples of loading data are detailed in later sections.

### Chemical Information

The <font face="CMTT10">tcplLoadChem</font> function returns chemical information for given parameters i.e. chemical name (chnm), chemical id (chid). The <font face="CMTT10">tcplLoadClib</font> function provides more information about the ToxCast chemical library used for sample generation.

### Methods

The <font face="CMTT10">tcplMthdList</font> function returns available methods at specified level. A function utilizing <font face="CMTT10">tcplMthdList</font> to that output all available methods is included below. The <font face="CMTT10">tcplMthdLoad</font> return the method assignments at specified id(s). Examples of loading methods for individuals ids are detailed in later sections.

```{r mthd_list, eval = FALSE}
# List all methods (sc and mc)
method_list <- function() {
  #sc
  sc1 <- tcplMthdList(1, 'sc')
  sc1[, lvl := "sc1"]
  setnames(sc1, c("sc1_mthd", "sc1_mthd_id"), c("mthd", "mthd_id"))
  
  sc2 <- tcplMthdList(2, 'sc')
  sc2[, lvl := "sc2"]
  setnames(sc2, c("sc2_mthd", "sc2_mthd_id"), c("mthd", "mthd_id"))
  
  #mc
  mc2 <- tcplMthdList(2, 'mc')
  mc2[, lvl := "mc2"]
  setnames(mc2, c("mc2_mthd", "mc2_mthd_id"), c("mthd", "mthd_id"))
  
  mc3 <- tcplMthdList(3, 'mc')
  mc3[, lvl := "mc3"]
  setnames(mc3, c("mc3_mthd", "mc3_mthd_id"), c("mthd", "mthd_id"))
  
  mc4 <- tcplMthdList(4, 'mc')
  mc4[, lvl := "mc4"]
  setnames(mc4, c("mc4_mthd", "mc4_mthd_id"), c("mthd", "mthd_id"))
  
  mc5 <- tcplMthdList(5, 'mc')
  mc5[, lvl := "mc5"]
  setnames(mc5, c("mc5_mthd", "mc5_mthd_id"), c("mthd", "mthd_id"))
  
  mthd.list <- rbind(sc1, sc2, mc2, mc3, mc4, mc5)
  mthd.list <- mthd.list[, c("lvl", "mthd_id", "mthd", "desc")]}
method_list <- method_list()
```

# Retrieving Level 0 Data

Prior to the pipeline processing provided in this package, all the data must go through pre-processing (level 0). Heterogeneous assay data is pre-processed into a uniform format using dataset-specific R scripts and loaded into the <font face="CMTT10">tcpl</font> database. The standard Level 0 format is identical between testing paradigms, single concentration (sc) or multi-concentration (mc). Users can inspect the level 0 data and calculate the example assay quality metrics.

## Load SC0 Data

```{r sc0, eval = FALSE}
# Load Level 0 single-concentration data for acid to R
sc0 <- tcplLoadData(lvl=0, # data level
                    fld="acid", # field to query on
                    val=1, # value for each field, must be same order as 'fld'
                    type = "sc") # data type - single concentration
# Alternatively, load in readable format with tcplPrepOtpt
sc0 <- tcplPrepOtpt(tcplLoadData(lvl=0, fld="acid", val=1, type = "sc"))
```

## Load MC0 Data

```{r mc0, eval = FALSE}
# Load Level 0 multi-concentration data
mc0 <- tcplPrepOtpt(tcplLoadData(lvl=0, # data level
                                fld="acid", # field to query on
                                val=1, # value for each field, must be same order as 'fld'
                                type = "mc") # data type - multi concentration
head(mc0)
```

## Review MC assay quality

```{r mc0_aq, eval = FALSE}
# Review assay quality metrics using indexed Level 0 data
aq <- function(ac){
  dat <- tcplPrepOtpt(tcplLoadData(1L, "acid", aeids$acid, type="mc"))
  dat <- dat[wllq==1]
  agg <- dat[ , list(
    nmed = median(rval[wllt=="n"], na.rm=TRUE), #median rval of n well 
    nmad = mad(rval[wllt=="n"], na.rm=TRUE), #mean abs deviation of n wells
    pmed = median(rval[wllt=="p"], na.rm=TRUE), #median rval of p well (positive control)
    pmad = mad(rval[wllt=="p"], na.rm=TRUE), #mean abs deviation of p wells
    mmed = median(rval[wllt=="m"], na.rm=TRUE), #median rval of m well (negative control)
    mmad = mad(rval[wllt=="m"], na.rm=TRUE) #mean abs deviation of m wells 
  ), by = list(acid, acnm, apid)]
  
  agg[ , zprm.p := 1 - ((3 * (pmad + nmad)) / abs(pmed - nmed))]  
  agg[ , zprm.m := 1 - ((3 * (mmad + nmad)) / abs(mmed - nmed))]
  # Z prime factor: separation between positive and negative controls, indicative of likelihood of false positives or negatives. 
  # Values between 0.5 - 1 are excellent,  between 0 and 0.5 may be acceptable, less than 0 not good
  agg[ , ssmd.p := (pmed - nmed) / sqrt(pmad^2 + nmad^2 )]
  agg[ , ssmd.m := (mmed - nmed) / sqrt(mmad^2 + nmad^2 )]
  agg[ , cv     := nmad / nmed] 
  # coefficient of Variation of neutral control, ideally should be under 25%
  agg[ , sn.p :=  (pmed - nmed) / nmad]
  agg[ , sn.m :=  (mmed - nmed) / nmad]
  agg[ , sb.p :=  pmed / nmed]
  agg[ , sb.m :=  mmed / nmed]
  
  agg[zprm.p<0, zprm.p := 0]
  agg[zprm.m<0, zprm.m := 0]
  
  acqu <- agg[ , list( nmed   = signif(median(nmed, na.rm = TRUE)),
                       nmad   = signif(median(nmad, na.rm = TRUE)),
                       pmed   = signif(median(pmed, na.rm = TRUE)),
                       pmad   = signif(median(pmad, na.rm = TRUE)),
                       mmed   = signif(median(mmed, na.rm = TRUE)),
                       mmad   = signif(median(mmad, na.rm = TRUE)),
                       zprm.p = round(median(zprm.p, na.rm=TRUE),2),
                       zprm.m = round(median(zprm.m, na.rm=TRUE),2),
                       ssmd.p = round(median(ssmd.p, na.rm=TRUE),0),
                       ssmd.m = round(median(ssmd.m, na.rm=TRUE),0),
                       cv = round(median(cv, na.rm=TRUE),2),
                       sn.p = round(median(sn.p, na.rm=TRUE),2),
                       sn.m = round(median(sn.m, na.rm=TRUE),2),
                       sb.p = round(median(sb.p, na.rm=TRUE),2),
                       sb.m = round(median(sb.m, na.rm=TRUE),2)
  ), by = list(acid, acnm)]
  
  return(acqu)
} #per acid 
aq<- aq(ac)
head(aq)
```

# Retrieving Processed Single-Concentration Data and Methods

The goal of single-concentration processing is to identify potentially active compounds from a broad screen at a single concentration. After processing, users can inspect single concentration activity hit calls and methods. 

## Load SC2 Data

```{r sc2, eval = FALSE}
# Load Level 2 single-concentration data for select aeids
# Alternativly, individual ids can be specified
sc2 <- tcplPrepOtpt(tcplLoadData(lvl=2, fld="aeid", val=aeids$aeid, type = "sc"))
```

## Load SC Methods

```{r sc2_mthd, eval = FALSE}
#Load methods for single-concentration data processing for select aeids
sc_methods <- function(aeids) {
  sc1_mthds <- tcplMthdLoad(lvl=1, type ="sc", id=aeids$aeid)
  sc1_mthds<- aggregate(mthd_id ~ aeid, sc1_mthds, toString)
  setnames(sc1_mthds, "mthd_id", "sc1_mthd_id")
  sc2_mthds <- tcplMthdLoad(lvl=2, type ="sc", id=aeids$aeid)
  sc2_mthds<- aggregate(mthd_id ~ aeid, sc2_mthds, toString)
  setnames(sc2_mthds, "mthd_id", "sc2_mthd_id")
methods <- merge( merge(aeids, sc1_mthds,  by = "aeid", all = TRUE), 
                  sc2_mthds, by = "aeid", all = TRUE ) }
sc_methods <- sc_methods(aeids)
```

# Retrieving Processed Multi-Concentration Data, Methods, and Plots

The goal of multiple-concentration processing is to estimate the activity, potency, efficacy, and other parameters for sample-assay pairs. After processing, users can inspect multi-concentration activity hit calls, model parameters, concentration-response plots, and methods. 

## Load MC5 Data

```{r mc5_data, eval = FALSE}
# Load Level 5 multi-concentration data summary values for select aeids
# Alternatively, individual aeids can be specified
mc5 <- tcplPrepOtpt(tcplLoadData(lvl=5, # data level
                                 fld="aeid", # fields to query on 
                                 val=aeids$aeid, # value for each field, must be same order as 'fld'
                                 type = "mc")) # data type - multi concentration
#For tcpl_v3 onwards, add.fld=TRUE must be specified to output mc5_param combined with mc5. add.fld=FALSE is default if not specified
mc5 <- tcplPrepOtpt(tcplLoadData(lvl=5,# data level
                                 fld="aeid", # fields to query on 
                                 val=aeids$aeid, # value for each field, must be same order as 'fld'
                                 type = "mc")) # data type - multi concentration
                                 add.fld=TRUE)) # return additional parameters from mc5_param
```

## Load MC Methods

```{r mc5_methods, eval = FALSE}
# Load methods for multi-concentration data processing for select aeids
methods <- function(aeids) {
  #acid
  mc2_mthds <- tcplMthdLoad(2,aeids$acid)
  mc2_mthds<- aggregate(mthd_id ~ acid, mc2_mthds, toString)
  setnames(mc2_mthds, "mthd_id", "mc2_mthd_id")
  #aeid
  mc3_mthds <- tcplMthdLoad(3,aeids$aeid)
  mc3_mthds<- aggregate(mthd_id ~ aeid, mc3_mthds, toString)
  setnames(mc3_mthds, "mthd_id", "mc3_mthd_id")
  mc4_mthds <- tcplMthdLoad(4,aeids$aeid)
  mc4_mthds<- aggregate(mthd_id ~ aeid, mc4_mthds, toString) 
  setnames(mc4_mthds, "mthd_id", "mc4_mthd_id")
  mc5_mthds <- tcplMthdLoad(5,aeids$aeid)
  mc5_mthds<- aggregate(mthd_id ~ aeid, mc5_mthds, toString)
  setnames(mc5_mthds, "mthd_id", "mc5_mthd_id")

  acid.methods <- merge(aeids, mc2_mthds,by.x = "acid", by.y = "acid")
  
  mthd35 <- merge( merge(mc3_mthds, mc4_mthds, by = "aeid", all = TRUE ), mc5_mthds, by = "aeid", all = TRUE )
  methods <- merge(acid.methods, mthd35,by.x = "aeid", by.y = "aeid")
  print(methods) }
methods <- methods(aeids)
```

## Plot MC Data

The <font face="CMTT10">tcplPlot</font> function is the generic plotting function that returns a plot for the given level and parameters.

```{r mc_plots, eval = FALSE}
# Create Level 4 plot for a single m4id
tcplPlot(lvl = 4,  # data level
         fld = "m4id", # field to query on 
         val = c(18609966), # value for each field, must be same order as 'fld'
         multi = FALSE, # output 6 plots per page if TRUE
         verbose = FALSE, # output all details if TRUE
         output = "console") # output in R console

# Plot Level 5 multi-concentration data for select aeids
tcplPlot(lvl = 5, # data level
         fld = "aeid", # field to query on
         val = 3157:3159, # value for each field, must be same order as 'fld'
         by = "aeid", # parameter to divide files
         multi = TRUE, # output 6 plots per page if TRUE
         verbose = TRUE, # output all details if TRUE
         output = "pdf", # output as pdf
         fileprefix = "output/", ) # prefix of filename
```

# Additional Examples

Listed below are a few case examples to retrieve different information from the database.

## Load Data for a Specific Chemical

This example illustrates the necessary steps for extracting information about *Bisphenol A* found within the <font face="CMTT10">tcpl</font> database. The user will define the chemical of interest, isolate all associated sample ids ($\mathit{spids}$), then load all data for the given chemical. 

```{r BPA, eval = FALSE}
# Provide the chemical name and assign to 'chnm'.
chnm <- 'Bisphenol A'
# Load the chemical data from the database
chem <- tcplLoadChem(field = 'chnm',val = chnm)
# Load mc5 data from the database for given chemical
BPA.mc5 <- tcplLoadData(lvl = 5, # data level 
                        fld = 'spid', # field to query on
                        val = chem[,spid], # value for each field, must be same order as 'fld'
                        type = 'mc') # the data type - multiple concentration

```

## Plot Sample Subset 

This example illustrates how to plot by endpoint for a sample subset, as opposed to plotting all samples tested within an endpoint. The user will load data for the select endpoints, isolate the samples of interest, then plot by endpoint for the sample subset. 

```{r spid_plot, eval=FALSE}
# Load Level 5 multi-concentration data summary values for select aeids
mc5 <- tcplPrepOtpt(tcplLoadData(lvl=5, # data level
                                 fld='aeid', # fields to query on 
                                 val=tcplLoadAeid(fld="asid", val = 25)$aeid, # value for each field, must be same order as 'fld'
                                 type='mc', # data type - multi concentration
                                 add.fld=TRUE)) # return additional parameters from mc5_param
# Identify sample subset
spid.mc5 <- mc5[spid %in% c("EPAPLT0018N08", "EPAPLT0023A16", "EPAPLT0020C11", 	
                            "EPAPLT0018B13","EPAPLT0018B14","EPAPLT0018B15"),]
# Plot by endpoint for sample subset
tcplPlot(lvl = 5, #data level
         fld = c("spid","aeid"), # fields to query on
         val = list(spid.mc5$spid,spid.mc5$aeid), # value for each field, must be same order as 'fld'
         by = "aeid", # parameter to divide files
         multi = TRUE, # output 6 plots per page if TRUE
         verbose = TRUE, # output all details if TRUE
         output = "pdf", # output as pdf
         fileprefix = "output/upitt") # prefix of filename

```

# Session Information

```{r echo=FALSE,warning=FALSE}
sessionInfo()
```